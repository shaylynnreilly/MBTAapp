<!DOCTYPE html>
<html>
    <head>
        <title>MBTA</title>
        <meta name = "viewport" content = "initial-scale = 1.0, user-scalable = no" charset = "utf-8" />
        <link rel="stylesheet" type="text/css" href="index.css">
        <script type="text/javascript"
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA_qfmjBfmskPfrhZdBkLEoikxlUmXtQQU">
        </script>
        <script type="text/javascript">
            var myLat = 0;
            var myLng = 0;
            var request;
	    var stops;
	    var text;
            //my position
            var me = new google.maps.LatLng(myLat, myLng);
            var myOptions = {
                        zoom: 17, // The larger the zoom number, the bigger the zoom
                        center: me,
                        mapTypeId: google.maps.MapTypeId.ROADMAP
                    };
            var map;
            var marker;
            var infowindow = new google.maps.InfoWindow();
            var places;
            
            //initializes map
            function init()
            {
                map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);
                getMyLocation();
            }
            
            //retrieves my location using geolocation
            function getMyLocation()
            {
                if (navigator.geolocation) { // the navigator.geolocation object is supported on your browser
                    navigator.geolocation.getCurrentPosition(function(position) {
                        myLat = position.coords.latitude;
                        myLng = position.coords.longitude;
                        renderMap();
                    });
                }
                else {
                    alert("Geolocation is not supported by your web browser.");
                }
            }
            //renders map with me as center and sends my data to datastore
            function renderMap()
            {
                me = new google.maps.LatLng(myLat, myLng);
                console.log(myLat + " " + myLng);
                // Update map and go there...
                map.panTo(me);
                //pull data
                request = new XMLHttpRequest(); 
                request.onreadystatechange = dataReady;
                url = "http://realtime.mbta.com/developer/api/v2/stopsbylocation?api_key=wX9NwuHnZU2ToO7GmGR9uw&lat=" + myLat + "&lon=" + myLng + "&format=json"
                request.open("GET", url , true);
                request.send();
                // Create a marker
                marker = new google.maps.Marker({
                    position: me,
                    title: "Me",
		    label: "ãƒƒ",
                });
                marker.setMap(map);
                // Open info window on click of marker
                google.maps.event.addListener(marker, 'click', function() {
                    infowindow.setContent(marker.title);
                    infowindow.open(map, marker);
                });
            }
            //gets data & calls functions to make markers
            function dataReady() {
                if (request.readyState == 4 && request.status == 200) {
                    response = JSON.parse(request.responseText);
                    stops = response.stop;
                    for (i = 0; i < stops.length; i++) {
                      stop = stops[i];
 		      if (stop.parent_station == "")
                      	plotStation(stop);
                    }
                }
            }
            function plotStation(stop) {
		//checks to see if parent station exists
		
                //gets station's position
                pos = new google.maps.LatLng(stop.stop_lat, stop.stop_lon);
                // Create a marker
                var stop_marker = new google.maps.Marker({
                    position: pos,
                    title: stop.stop_name,
                });
                stop_marker.setMap(map);
                // Open info window on click of marker
                google.maps.event.addListener(stop_marker, 'click', function() {
		    request2 = new XMLHttpRequest(); 
                    request2.onreadystatechange = getRoutes;
                    url2 = "http://realtime.mbta.com/developer/api/v2/predictionsbystop?api_key=wX9NwuHnZU2ToO7GmGR9uw&stop=" + stop.stop_id + "&format=json"
                    request2.open("GET", url2 , true);
                    request2.send();
		    //allows time for request to go through
		    setTimeout(function(){
                current_time = new Date();
                hour = current_time.getHours();
                        if (hour == 0 || hour == 12) 
                            mod_hour = 12
                        else 
                            mod_hour = hour % 12;
                        if (hour >= 12)
                            stamp = "pm";
                        else
                            stamp = "am";
                        minutes = current_time.getMinutes();
                        if (minutes < 10)
                            minutes = "0" + minutes;
    			content = "<p><b style='font-size:20px'>" + stop.stop_name + "</b><br>Current time: " + mod_hour + ":" + minutes + stamp + "<br>" + text;
                    	infowindow.setContent(content);
                    	infowindow.open(map, stop_marker);
		    }, 700);
                });
            }
	    function getRoutes() {
		if (this.readyState == 4 && this.status == 200) {
		    console.log(this.readyState);
            route_response = JSON.parse(this.responseText);
		    modes = route_response.mode;
		    text = "";
		    for (x = 0; x < modes.length; x++) {
			text = text + "<br><u>" + modes[x].mode_name + "</u>";
			for (y = 0; y < modes[x].route.length; y++) {
				text = text + "<br/>" + modes[x].route[y].route_name;
				for (z = 0; z < modes[x].route[y].direction.length; z++) {
                    text = text + "<br>To " + modes[x].route[y].direction[z].trip[0].trip_headsign + ": ";
                    for (w = 0; w < modes[x].route[y].direction[z].trip.length && w < 5; w++) {
					   date = new Date(modes[x].route[y].direction[z].trip[w].sch_arr_dt * 1000);
                        hour = date.getHours();
                        if (hour == 0 || hour == 12) 
                            mod_hour = 12
                        else 
                            mod_hour = hour % 12;
                        if (hour >= 12)
                            stamp = "pm";
                        else
                            stamp = "am";
                        minutes = date.getMinutes();
                        if (minutes < 10)
                            minutes = "0" + minutes; 
					   text = text + mod_hour + ":" + minutes + stamp;
                       if (w != modes[x].route[y].direction[z].trip.length - 1 && w != 4)
                            text = text + ", ";
                    }
				}
                text = text + "<br>";
			}
		    }
		    text = text + "</p>";
		}
	    } 
        </script>
    </head>
    <body onload ="init()">
        <div id="map_canvas">
        </div>
    </body>
</html>
